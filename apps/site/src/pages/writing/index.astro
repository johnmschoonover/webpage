---
import BaseLayout from '@layouts/BaseLayout.astro';
import WritingGallery from '@components/Writing/WritingGallery';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).sort((a, b) => (a.data.date > b.data.date ? -1 : 1));
const clientPosts = posts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  summary: post.data.summary,
  date: post.data.date,
  displayDate: new Date(post.data.date).toLocaleDateString(undefined, {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  }),
  tags: post.data.tags ?? []
}));
const newestPost = clientPosts[0];
const publishedCount = clientPosts.length;
const tagCount = Array.from(new Set(clientPosts.flatMap((post) => post.tags))).length;
---
<BaseLayout
  pageHeading="Writing"
  description="Strategy notes and experiments from the security platform trenches."
>
  <section class="grid gap-8 rounded-3xl border border-border bg-gradient-to-br from-background via-background to-muted/30 p-8 shadow-sm md:grid-cols-[2fr,1fr]">
    <div class="space-y-4">
      <p class="text-sm uppercase tracking-[0.35em] text-muted-foreground">Field journal</p>
      <h2 class="font-display text-3xl font-semibold text-foreground md:text-4xl">
        Platform leadership insights delivered with practitioner clarity.
      </h2>
      <p class="text-base text-muted-foreground md:text-lg">
        Explorations of how high-trust teams build resilient telemetry, shape defenses through data, and lead with empathy.
        Subscribe via RSS or drop new prompts for future posts anytime.
      </p>
      <div class="flex flex-wrap gap-4 text-sm text-muted-foreground">
        <span class="rounded-full border border-border px-3 py-1">
          {publishedCount} {publishedCount === 1 ? 'post' : 'posts'} shipped
        </span>
        <span class="rounded-full border border-border px-3 py-1">{tagCount} topics</span>
        {newestPost && (
          <a
            href={`/writing/${newestPost.slug}/`}
            class="inline-flex items-center gap-2 rounded-full border border-border px-3 py-1 text-primary transition hover:border-primary hover:text-primary"
          >
            Latest: {newestPost.title}
          </a>
        )}
      </div>
    </div>
    <div class="space-y-4 rounded-2xl border border-border bg-background/80 p-6">
      <h3 class="font-display text-lg font-semibold text-foreground">How publishing works</h3>
      <ol class="list-decimal space-y-2 pl-5 text-sm text-muted-foreground">
        <li>
          Draft posts locally in Markdown or MDX. The repo keeps everything under
          <code>apps/site/src/content/posts</code> so copy lives alongside code reviews.
        </li>
        <li>
          Commit the new file and any images in <code>apps/site/public/images/posts</code>, then open a pull request on GitHub for
          review.
        </li>
        <li>Ship once checks pass and the writing reads clearly on mobile and desktop.</li>
      </ol>
    </div>
  </section>

  <WritingGallery client:load posts={clientPosts} />
</BaseLayout>
