---
import BaseLayout from '@layouts/BaseLayout.astro';
import WritingGallery from '@components/Writing/WritingGallery';
import { getCollection } from 'astro:content';

Astro.response.headers.set('Cache-Control', 'public, max-age=0, must-revalidate');

const posts = (await getCollection('posts', ({ data }) => !data.draft)).sort((a, b) => (a.data.date > b.data.date ? -1 : 1));
const clientPosts = posts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  summary: post.data.summary,
  date: post.data.date,
  displayDate: new Date(post.data.date).toLocaleDateString(undefined, {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  }),
  tags: post.data.tags ?? []
}));
const newestPost = clientPosts[0];
const publishedCount = clientPosts.length;
const tagCount = Array.from(new Set(clientPosts.flatMap((post) => post.tags))).length;
---
<BaseLayout
  pageHeading="Writing"
  description="Strategy notes and experiments from the security platform trenches."
>
  <section class="grid gap-8 rounded-3xl border border-border bg-gradient-to-br from-background via-background to-muted/30 p-8 shadow-sm">
    <div class="space-y-4">
      <p class="text-sm uppercase tracking-[0.35em] text-muted-foreground">Explorations</p>
      <h2 class="font-display text-3xl font-semibold text-foreground md:text-4xl">
        Notes on engineering, leadership, and discovery.
      </h2>
      <p class="text-base text-muted-foreground md:text-lg">
        A collection of field notes on building resilient teams, security platforms, and exploring the mathematics and systems that shape our world.
        Subscribe via RSS or drop new prompts for future posts anytime.
      </p>
      <div class="flex flex-wrap gap-4 text-sm text-muted-foreground">
        <span class="rounded-full border border-border px-3 py-1">
          {publishedCount} {publishedCount === 1 ? 'post' : 'posts'} shipped
        </span>
        <span class="rounded-full border border-border px-3 py-1">{tagCount} topics</span>
        {newestPost && (
          <a
            href={`/writing/${newestPost.slug}/`}
            class="inline-flex items-center gap-2 rounded-full border border-border px-3 py-1 text-primary transition hover:border-primary hover:text-primary"
          >
            Latest: {newestPost.title}
          </a>
        )}
      </div>
    </div>
  </section>

  <WritingGallery client:load posts={clientPosts} />
</BaseLayout>
